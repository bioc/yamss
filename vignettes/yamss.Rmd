---
title: "The yamss User's Guide"
author: "Leslie Myint"
date: "`r doc_date()`"
package: "`r pkg_ver('yamss')`"
bibliography: yamss.bib
abstract: >
  A comprehensive guide to using the yamss package for analyzing
  high-throughput metabolomics data
vignette: >
  %\VignetteIndexEntry{yamss User's Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::pdf_document
---

# Introduction

The `yamss` package provides tools to preprocess raw mass spectral data files arising from metabolomics experiments with the primary goal of providing high-quality differential analysis. Existing software packages such as XCMS (available on Bioconductor) and MZMine 2 also provide preprocessing functionality but focus more on feature detection and alignment in individual samples ([@xcms], [@mzmine]). We emphasize that `yamss` implements many of the same stages as these packages (namely background correction, retention time alignment, and peak detection), but tht output of `yamss` is targeted to more statistically powerful inference about comparisons between groups of samples.

## Dependencies

This document has the following dependencies

```{r dependencies, warning=FALSE, message=FALSE}
library(yamss)
library(mtbls2)
```

# Processing a metabolomics dataset

We will be looking at data provided in the `mtbls2` data package. In this experiment, investigators exposed wild-type and mutant *Arabidopsis thaliana* leaves to silver nitrate and performed global LC/MS profiling. The experiment was repeated twice, but we will only be looking at the first replicate. There are 4 wild-type and 4 mutant plants in this experiment.

```{r}
filepath <- file.path(find.package("mtbls2"), "mzData")
files <- list.files(filepath, pattern = "MSpos-Ex1", recursive = TRUE, full.names = TRUE)
classes <- rep(c("wild-type", "mutant"), each = 4)
```

All that is needed to process these raw mass spectral data files is the `bakedpi` function. The `dbandwidth` and `dgridstep` arguments influence the bivariate kernel density estimation. `dgridstep` is a vector of length 2 that specifies the spacing of the grid upon which the density is estimated. The first component specifies the spacing in the M/Z direction, and the second component specifies the spacing in the scan (retention time) direction. In order to showcase a fast example, we have specified the M/Z and scan spacings to be `0.01` and `1` respectively, but we recommend keeping the defaults of `0.005` and `1` because this will more accurately define the M/Z and scan bounds of the detected peaks. `dbandwidth` is a vector of length 2 that specifies the kernel density bandwidth in the M/Z and scan directions in the first and second components respectively. Note that `dbandwidth[1]` should be greater than or equal to `dgridstep[1]` and `dbandwidth[2]` should be greater than or equal to `dgridstep[2]`. Because a binning strategy is used to speed up computation of the density estimate, this is to ensure that data points falling into the same grid location all have the same distances associated with them.

For experiments with a wide range of M/Z values or several thousands of scans, the computation of the density estimate can be time-intensive. For this reason, it can be useful to save the density estimate in an external file specified by the `outfileDens` argument. If `outfileDens` is set to `NULL`, then the density estimate is not saved and must be recomputed if you wish to process the data again. Specifying the filename of the saved density estimate in `outfileDens` when rerunning `bakedpi` skips the density estimation phase which can save a lot of time.

```{r}
cmsobj <- bakedpi(files = files, classes = classes, dbandwidth = c(0.01, 10), dgridstep = c(0.01, 1), outfileDens = NULL, dortalign = TRUE, mzsubset = c(500, 520), verbose = TRUE)
```

The resulting object is an instance of class `cms` and contains several pieces of information used in preprocessing as well as differential analysis results.

We can access the differential analysis report with `diffrep`.

```{r}
dr <- diffrep(cmsobj)
head(dr)
```

Let's look at the peak bound information for the peaks with the strongest differential signal. We can store the IDs for the top 10 peaks with

```{r}
topPeaks <- as.numeric(rownames(dr)[1:10])
```

We can access the peak bound information with `peakBounds` and select the rows corresponding to `topPeaks`.

```{r}
bounds <- peakBounds(cmsobj)
idx <- match(topPeaks, bounds[,"blobnum"])
bounds[idx,]
```

# Information contained in a cms object

In addition to differential analysis results, `cms` objects contain information useful in exploring your data.

## Density estimate

The bivariate kernel density estimate matrix can be accessed with `densityEstimate`.

```{r}
dmat <- densityEstimate(cmsobj)
```

We can make a plot of the density estimate in a particular M/Z and scan region with `plotDensityRegion`.

```{r}
mzrange <- bounds[idx[1], c("mzmin", "mzmax")]
scanrange <- bounds[idx[1], c("scan.min", "scan.max")]
plotDensityRegion(cmsobj, mzrange = mzrange, scanrange = scanrange)
```

# Sessioninfo

```{r sessionInfo, results='asis', echo=FALSE}
toLatex(sessionInfo())
```

# References


